const fs = require('fs');
const path = require('path');

// Skip if explicitly disabled
if (process.env.SKIP_HOOKS === 'true') {
  console.log('⚠️  SKIP_HOOKS=true detected. Skipping git hooks setup.');
  process.exit(0);
}

// Skip in CI environments automatically
if (process.env.CI || process.env.GITHUB_ACTIONS || process.env.GITLAB_CI || process.env.CIRCLECI || process.env.JENKINS_HOME || process.env.TRAVIS) {
  console.log('⚠️  CI environment detected. Skipping git hooks setup.');
  process.exit(0);
}

const hooksDir = path.join(__dirname, '..', '.git', 'hooks');
const preCommitHook = path.join(hooksDir, 'pre-commit');
const checkScriptPath = path.join(__dirname, 'check-eslint.js');

// Check if .git directory exists (skip in CI or template creation)
if (!fs.existsSync(path.join(__dirname, '..', '.git'))) {
  console.log('⚠️  No .git directory found. Skipping git hooks setup.');
  process.exit(0);
}

// Ensure hooks directory exists
if (!fs.existsSync(hooksDir)) {
  fs.mkdirSync(hooksDir, { recursive: true });
}

// Create pre-commit hook
const hookContent = `#!/bin/sh
# Pre-commit hook - Code quality check
# Auto-generated by npm postinstall

echo "Running ESLint check..."
export PATH="$PATH:/usr/local/bin"
node "${checkScriptPath}"
`;

try {
  fs.writeFileSync(preCommitHook, hookContent, { mode: 0o755 });
  console.log('✅ Pre-commit hooks installed successfully');
} catch (error) {
  console.error('❌ Failed to install pre-commit hooks:', error.message);
  process.exit(1);
}
